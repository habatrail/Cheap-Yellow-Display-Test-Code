#include <SPI.h>
#include <SD.h>
#include <TFT_eSPI.h>
#include <TJpg_Decoder.h>
#include <esp_now.h>
#include <WiFi.h>

TFT_eSPI tft = TFT_eSPI();

// CYD Hardware Pins
#define SD_CS          5
#define TFT_CS         15
#define BACKLIGHT_PIN  21

// Game Data Structure
typedef struct struct_message {
    int cardID;
    int hp;
    int atk;
} struct_message;

struct_message myData;

// JPEG Output Bridge
bool tft_output(int16_t x, int16_t y, uint16_t w, uint16_t h, uint16_t* bitmap) {
  if (y >= tft.height()) return 0;
  tft.pushImage(x, y, w, h, bitmap);
  return 1;
}

// Callback when a game update is received
void OnDataRecv(const uint8_t * mac, const uint8_t *incomingData, int len) {
  memcpy(&myData, incomingData, sizeof(myData));
  
  Serial.printf("New Card Received: ID %d, HP %d\n", myData.cardID, myData.hp);
  
  // 1. Draw the Card Art
  String path = "/" + String(myData.cardID) + ".jpg";
  TJpgDec.drawSdJpg(0, 0, path.c_str());

  // 2. Overlay the Game HUD (Health & Attack)
  // Draw a semi-transparent-looking bar at the bottom
  tft.fillRect(0, 200, 320, 40, tft.color565(20, 20, 20)); 
  
  tft.setTextColor(TFT_WHITE);
  tft.setTextSize(2);
  tft.setCursor(15, 210);
  tft.printf("HP: %d", myData.hp);
  
  tft.setCursor(220, 210);
  tft.printf("ATK: %d", myData.atk);
}

void setup() {
  Serial.begin(115200);

  // Initialize Pins
  pinMode(TFT_CS, OUTPUT);
  pinMode(SD_CS, OUTPUT);
  pinMode(BACKLIGHT_PIN, OUTPUT);
  digitalWrite(TFT_CS, HIGH);
  digitalWrite(SD_CS, HIGH);

  // Start SD Card
  if (!SD.begin(SD_CS)) {
    Serial.println("SD Card Error!");
    return;
  }

  // Start Screen
  tft.init();
  tft.setRotation(1);
  tft.fillScreen(TFT_BLACK);
  digitalWrite(BACKLIGHT_PIN, HIGH);

  // Set up JPEG Decoder
  TJpgDec.setJpgScale(1);
  TJpgDec.setCallback(tft_output);

  // Splash Screen
  tft.setTextColor(TFT_GOLD);
  tft.drawCentreString("GAME TERMINAL READY", 160, 110, 4);

  // Initialize ESP-NOW
  WiFi.mode(WIFI_STA);
  esp_now_init();
  esp_now_register_recv_cb(esp_now_recv_cb_t(OnDataRecv));
}

void loop() {
  // The receiver is interrupt-driven; nothing needed here!
}
