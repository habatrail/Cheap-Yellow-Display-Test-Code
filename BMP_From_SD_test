#include <SPI.h>
#include <SD.h>
#include <TFT_eSPI.h>
#include <TJpg_Decoder.h>

TFT_eSPI tft = TFT_eSPI();

#define TFT_BL 21 
#define SD_CS  5

// We will use this to hold the image in memory
uint8_t* imageBuffer = nullptr;
size_t imageSize = 0;

// --- JPEG CALLBACK FUNCTION ---
bool tft_output(int16_t x, int16_t y, uint16_t w, uint16_t h, uint16_t* bitmap) {
  if ( y >= tft.height() ) return 0;
  tft.pushImage(x, y, w, h, bitmap);
  return 1;
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("\n--- RAM SCOOP JPEG TEST ---");

  // CYD specific armor: Mute the Touch Screen Controller
  // Sometimes the touch chip talks over the SD card. This forces it to stay quiet.
  pinMode(33, OUTPUT); 
  digitalWrite(33, HIGH);

  // Initialize Screen
  tft.init();
  tft.setRotation(1); 
  tft.fillScreen(TFT_BLACK);
  tft.setSwapBytes(true); 
  analogWrite(TFT_BL, 200);

  // Initialize SD
  if (!SD.begin(SD_CS)) {
    Serial.println("CRITICAL ERROR: SD Mount Failed");
    tft.fillScreen(TFT_RED);
    return;
  }

  // 1. OPEN THE FILE
  fs::File jpgFile = SD.open("/1.jpg", FILE_READ);
  if (!jpgFile) {
    Serial.println("ERROR: Could not find /1.jpg");
    return;
  }

  imageSize = jpgFile.size();
  Serial.print("File Size: "); 
  Serial.print(imageSize); 
  Serial.println(" bytes");

  // 2. ALLOCATE ESP32 MEMORY
  imageBuffer = (uint8_t*)malloc(imageSize);
  if (imageBuffer == nullptr) {
    Serial.println("ERROR: ESP32 Out of Memory! Is the JPEG too large?");
    jpgFile.close();
    return;
  }

  // 3. READ ENTIRE FILE INTO RAM AT ONCE
  Serial.println("Scooping file from SD to RAM...");
  uint32_t loadTime = millis();
  
  jpgFile.read(imageBuffer, imageSize);
  jpgFile.close(); // Completely close the SD card!
  
  Serial.print("SD Read Time: "); 
  Serial.print(millis() - loadTime); 
  Serial.println(" ms");

  // 4. SETUP DECODER
  TJpgDec.setJpgScale(1);
  TJpgDec.setCallback(tft_output);

  // 5. DRAW FROM RAM TO SCREEN
  Serial.println("Decoding and drawing from RAM...");
  uint32_t drawTime = millis();
  
  // Notice we use drawJpg instead of drawSdJpg!
  TJpgDec.drawJpg(0, 0, imageBuffer, imageSize);
  
  Serial.print("Screen Draw Time: "); 
  Serial.print(millis() - drawTime); 
  Serial.println(" ms");

  // 6. FREE THE MEMORY
  free(imageBuffer);
  Serial.println("Done! Memory freed for the next card.");
}

void loop() {
  // Enjoy the image
}
